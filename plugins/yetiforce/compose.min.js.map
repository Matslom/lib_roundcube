{"version":3,"file":"compose.min.js","sources":["compose.js"],"sourcesContent":["'use strict';\n/* {[The file is published on the basis of MIT License]} */\nif (window.rcmail) {\n  rcmail.addEventListener('init', function () {\n    rcmail.crm = rcmail.getCrmWindow();\n    if (rcmail.crm != false) {\n      rcmail.env.compose_commands.push('yetiforce.addFilesFromCRM');\n      rcmail.env.compose_commands.push('yetiforce.selectTemplate');\n      rcmail.env.compose_commands.push('yetiforce.selectAdress');\n      rcmail.register_command(\n        'yetiforce.addFilesFromCRM',\n        function () {\n          rcmail.addFilesFromCRM();\n        },\n        true\n      );\n      rcmail.register_command(\n        'yetiforce.selectTemplate',\n        function () {\n          rcmail.selectTemplate();\n        },\n        true\n      );\n      rcmail.register_command(\n        'yetiforce.selectAdress',\n        function (module, part) {\n          rcmail.selectAdress(module, part);\n        },\n        true\n      );\n    }\n  });\n}\n//Document selection\nrcube_webmail.prototype.addFilesFromCRM = function () {\n  rcmail.crm.app.showRecordsList(\n    {\n      module: 'Documents',\n      src_module: 'Documents',\n      multi_select: true,\n      additionalInformations: true,\n    },\n    (modal, instance) => {\n      instance.setSelectEvent((responseData) => {\n        rcmail.addFilesToMail({\n          ids: Object.keys(responseData),\n        });\n      });\n    }\n  );\n};\n//Add files to mail\nrcube_webmail.prototype.addFilesToMail = function (data) {\n  data._id = rcmail.env.compose_id;\n  data._uploadid = new Date().getTime();\n  this.http_post('plugin.yetiforce-addFilesToMail', data, this.set_busy(true, 'loading'));\n};\n// Select template\nrcube_webmail.prototype.selectTemplate = function () {\n  rcmail.crm.app.showRecordsList(\n    {\n      module: 'EmailTemplates',\n      src_module: 'EmailTemplates',\n      search_params: '[[[\"email_template_type\",\"e\",\"PLL_MAIL\"]]]',\n    },\n    (modal, instance) => {\n      instance.setSelectEvent((responseData) => {\n        var recordId = rcmail.env.crmRecord,\n          module = rcmail.env.crmModule,\n          view = rcmail.env.crmView;\n        if (view == 'List') {\n          var chElement = jQuery(crm.document).find('.listViewEntriesCheckBox')[0];\n          recordId = jQuery(chElement).val();\n        }\n        jQuery.ajax({\n          type: 'Get',\n          url: '?_task=mail&_action=plugin.yetiforce-getContentEmailTemplate&_id=' + rcmail.env.compose_id,\n          data: {\n            id: responseData.id,\n            record_id: recordId,\n            select_module: module,\n          },\n          dataType: 'json',\n          success: function (data) {\n            let oldSubject = jQuery('[name=\"_subject\"]').val(),\n              html = jQuery('<div/>').html(data.content).html(),\n              ed = '';\n            jQuery('[name=\"_subject\"]').val(oldSubject + ' ' + data.subject);\n            if (window.tinyMCE && (ed = tinyMCE.get(rcmail.env.composebody))) {\n              let oldBody = tinyMCE.activeEditor.getContent();\n              tinymce.activeEditor.setContent(html + oldBody);\n            } else {\n              let oldBody = jQuery('#composebody').val();\n              jQuery('#composebody').val(html + oldBody);\n            }\n            if (typeof data.attachments !== 'undefined' && data.attachments !== null) {\n              rcmail.addFilesToMail(data.attachments);\n            }\n          },\n        });\n      });\n    }\n  );\n};\nrcube_webmail.prototype.selectAdress = function (module, part) {\n  rcmail.crm.app.showRecordsList(\n    {\n      module: module,\n      src_module: 'OSSMail',\n      multi_select: true,\n      additionalInformations: false,\n    },\n    (modal, instance) => {\n      instance.setSelectEvent((responseData, e) => {\n        rcmail.getEmailAddresses(responseData, e, module).done((emails) => {\n          if (emails.length) {\n            let paetElement = $('#' + part);\n            let value = paetElement.val();\n            if (value != '' && value.charAt(value.length - 1) != ',') {\n              value = value + ',';\n            }\n            paetElement.val(value + emails.join(','));\n            paetElement.change();\n          } else {\n            rcmail.crm.app.showNotify({\n              text: rcmail.crm.app.vtranslate('NoFindEmailInRecord'),\n              animation: 'show',\n            });\n          }\n        });\n      });\n    }\n  );\n};\nrcube_webmail.prototype.getEmailAddresses = function (responseData, e, module) {\n  let aDeferred = $.Deferred(),\n    emails = [],\n    label = '',\n    email = '';\n  if (typeof e.target !== 'undefined' && ($(e.target).data('type') === 'email' || $(e.target).data('type') === 'multiEmail')) {\n    emails.push($(e.target).text());\n    aDeferred.resolve(emails);\n  } else {\n    let i = 0;\n    for (let id in responseData) {\n      rcmail.crm.app\n        .getRecordDetails({\n          record: id,\n          module: module,\n          fieldType: ['email', 'multiEmail'],\n        })\n        .done((data) => {\n          i++;\n          label = email = rcmail.getFirstEmailAddress(data.result.data);\n          if (responseData[id]) {\n            label = responseData[id];\n          }\n          emails.push(label + '<' + email + '>');\n          if (i === Object.keys(responseData).length) {\n            //last iteration\n            aDeferred.resolve(emails);\n          }\n        });\n    }\n  }\n  return aDeferred.promise();\n};\nrcube_webmail.prototype.getFirstEmailAddress = function (data) {\n  let emails = [];\n  for (let key in data) {\n    if (data[key]) {\n      if (rcmail.crm.app.isJsonString(data[key])) {\n        let multiEmail = JSON.parse(data[key]);\n        for (let i in multiEmail) {\n          emails.push(multiEmail[i].e);\n        }\n        break;\n      } else {\n        emails.push(data[key]);\n        break;\n      }\n    }\n  }\n  return emails;\n};\nrcube_webmail.prototype.getCrmWindow = function () {\n  if (opener !== null && opener.parent.CONFIG == 'object') {\n    return opener.parent;\n  } else if (typeof parent.CONFIG == 'object') {\n    return parent;\n  } else if (typeof parent.parent.CONFIG == 'object') {\n    return parent.parent;\n  } else if (typeof opener.crm.CONFIG == 'object') {\n    return opener.crm;\n  }\n  return false;\n};\n"],"names":["window","rcmail","addEventListener","crm","getCrmWindow","env","compose_commands","push","register_command","addFilesFromCRM","selectTemplate","module","part","selectAdress","rcube_webmail","prototype","app","showRecordsList","src_module","multi_select","additionalInformations","modal","instance","setSelectEvent","responseData","addFilesToMail","ids","Object","keys","data","_id","compose_id","_uploadid","getTime","http_post","set_busy","search_params","crmRecord","crmModule","view","crmView","jQuery","document","find","recordId","chElement","val","ajax","type","url","id","record_id","select_module","dataType","success","html","content","ed","oldSubject","subject","tinyMCE","get","composebody","activeEditor","getContent","tinymce","setContent","oldBody","attachments","e","getEmailAddresses","done","emails","length","$","value","paetElement","charAt","join","change","showNotify","text","vtranslate","animation","Deferred","label","email","target","aDeferred","resolve","getRecordDetails","record","fieldType","i","getFirstEmailAddress","result","promise","key","isJsonString","JSON","parse","multiEmail","parent","CONFIG","opener"],"mappings":"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"}