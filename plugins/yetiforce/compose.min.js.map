{"version":3,"file":"compose.min.js","sources":["compose.js"],"sourcesContent":["'use strict';\n/* {[The file is published on the basis of MIT License]} */\nif (window.rcmail) {\n\trcmail.addEventListener('init', function () {\n\t\trcmail.crm = rcmail.getCrmWindow();\n\t\tif (rcmail.crm != false) {\n\t\t\trcmail.env.compose_commands.push('yetiforce.addFilesFromCRM');\n\t\t\trcmail.env.compose_commands.push('yetiforce.selectTemplate');\n\t\t\trcmail.env.compose_commands.push('yetiforce.selectAdress');\n\t\t\trcmail.register_command(\n\t\t\t\t'yetiforce.addFilesFromCRM',\n\t\t\t\tfunction () {\n\t\t\t\t\trcmail.addFilesFromCRM();\n\t\t\t\t},\n\t\t\t\ttrue\n\t\t\t);\n\t\t\trcmail.register_command(\n\t\t\t\t'yetiforce.selectTemplate',\n\t\t\t\tfunction () {\n\t\t\t\t\trcmail.selectTemplate();\n\t\t\t\t},\n\t\t\t\ttrue\n\t\t\t);\n\t\t\trcmail.register_command(\n\t\t\t\t'yetiforce.selectAdress',\n\t\t\t\tfunction (module, part) {\n\t\t\t\t\trcmail.selectAdress(module, part);\n\t\t\t\t},\n\t\t\t\ttrue\n\t\t\t);\n\t\t}\n\t});\n}\n//Document selection\nrcube_webmail.prototype.addFilesFromCRM = function () {\n\trcmail.crm.app.showRecordsList(\n\t\t{\n\t\t\tmodule: 'Documents',\n\t\t\tsrc_module: 'Documents',\n\t\t\tmulti_select: true,\n\t\t\tadditionalInformations: true\n\t\t},\n\t\t(modal, instance) => {\n\t\t\tinstance.setSelectEvent((responseData) => {\n\t\t\t\trcmail.addFilesToMail({\n\t\t\t\t\tids: Object.keys(responseData)\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t);\n};\n//Add files to mail\nrcube_webmail.prototype.addFilesToMail = function (data) {\n\tdata._id = rcmail.env.compose_id;\n\tdata._uploadid = new Date().getTime();\n\tthis.http_post('plugin.yetiforce-addFilesToMail', data, this.set_busy(true, 'loading'));\n};\n// Select template\nrcube_webmail.prototype.selectTemplate = function () {\n\trcmail.crm.app.showRecordsList(\n\t\t{\n\t\t\tmodule: 'EmailTemplates',\n\t\t\tsrc_module: 'EmailTemplates',\n\t\t\tsearch_params: '[[[\"email_template_type\",\"e\",\"PLL_MAIL\"]]]'\n\t\t},\n\t\t(modal, instance) => {\n\t\t\tinstance.setSelectEvent((responseData) => {\n\t\t\t\tvar recordId = rcmail.env.yf_crmRecord,\n\t\t\t\t\tmodule = rcmail.env.yf_crmModule,\n\t\t\t\t\tview = rcmail.env.yf_crmView;\n\t\t\t\tif (view == 'List') {\n\t\t\t\t\tvar chElement = jQuery(crm.document).find('.listViewEntriesCheckBox')[0];\n\t\t\t\t\trecordId = jQuery(chElement).val();\n\t\t\t\t}\n\t\t\t\tjQuery.ajax({\n\t\t\t\t\ttype: 'Get',\n\t\t\t\t\turl: '?_task=mail&_action=plugin.yetiforce-getContentEmailTemplate&_id=' + rcmail.env.compose_id,\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tid: responseData.id,\n\t\t\t\t\t\trecord_id: recordId,\n\t\t\t\t\t\tselect_module: module\n\t\t\t\t\t},\n\t\t\t\t\tdataType: 'json',\n\t\t\t\t\tsuccess: function (data) {\n\t\t\t\t\t\tlet oldSubject = jQuery('[name=\"_subject\"]').val(),\n\t\t\t\t\t\t\thtml = jQuery('<div/>').html(data.content).html(),\n\t\t\t\t\t\t\ted = '';\n\t\t\t\t\t\tjQuery('[name=\"_subject\"]').val(oldSubject + ' ' + data.subject);\n\t\t\t\t\t\tif (window.tinyMCE && (ed = tinyMCE.get(rcmail.env.composebody))) {\n\t\t\t\t\t\t\tlet oldBody = tinyMCE.activeEditor.getContent();\n\t\t\t\t\t\t\ttinymce.activeEditor.setContent(html + oldBody);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlet oldBody = jQuery('#composebody').val();\n\t\t\t\t\t\t\tjQuery('#composebody').val(html + oldBody);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (typeof data.attachments !== 'undefined' && data.attachments !== null) {\n\t\t\t\t\t\t\trcmail.addFilesToMail(data.attachments);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t);\n};\nrcube_webmail.prototype.selectAdress = function (module, part) {\n\trcmail.crm.app.showRecordsList(\n\t\t{\n\t\t\tmodule: module,\n\t\t\tsrc_module: 'OSSMail',\n\t\t\tmulti_select: true,\n\t\t\tadditionalInformations: false\n\t\t},\n\t\t(modal, instance) => {\n\t\t\tinstance.setSelectEvent((responseData, e) => {\n\t\t\t\trcmail.getEmailAddresses(responseData, e, module).done((emails) => {\n\t\t\t\t\tif (emails.length) {\n\t\t\t\t\t\tlet paetElement = $('#' + part);\n\t\t\t\t\t\tlet value = paetElement.val();\n\t\t\t\t\t\tif (value != '' && value.charAt(value.length - 1) != ',') {\n\t\t\t\t\t\t\tvalue = value + ',';\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpaetElement.val(value + emails.join(','));\n\t\t\t\t\t\tpaetElement.change();\n\t\t\t\t\t} else {\n\t\t\t\t\t\trcmail.crm.app.showNotify({\n\t\t\t\t\t\t\ttext: rcmail.crm.app.vtranslate('NoFindEmailInRecord'),\n\t\t\t\t\t\t\tanimation: 'show'\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t);\n};\nrcube_webmail.prototype.getEmailAddresses = function (responseData, e, module) {\n\tlet aDeferred = $.Deferred(),\n\t\temails = [],\n\t\tlabel = '',\n\t\temail = '';\n\tif (\n\t\ttypeof e.target !== 'undefined' &&\n\t\t($(e.target).data('type') === 'email' || $(e.target).data('type') === 'multiEmail')\n\t) {\n\t\temails.push($(e.target).text());\n\t\taDeferred.resolve(emails);\n\t} else {\n\t\tlet i = 0;\n\t\tfor (let id in responseData) {\n\t\t\trcmail.crm.app\n\t\t\t\t.getRecordDetails({\n\t\t\t\t\trecord: id,\n\t\t\t\t\tmodule: module,\n\t\t\t\t\tfieldType: ['email', 'multiEmail']\n\t\t\t\t})\n\t\t\t\t.done((data) => {\n\t\t\t\t\ti++;\n\t\t\t\t\tlabel = email = rcmail.getFirstEmailAddress(data.result.data);\n\t\t\t\t\tif (responseData[id]) {\n\t\t\t\t\t\tlabel = responseData[id];\n\t\t\t\t\t}\n\t\t\t\t\temails.push(label + '<' + email + '>');\n\t\t\t\t\tif (i === Object.keys(responseData).length) {\n\t\t\t\t\t\t//last iteration\n\t\t\t\t\t\taDeferred.resolve(emails);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t}\n\t}\n\treturn aDeferred.promise();\n};\nrcube_webmail.prototype.getFirstEmailAddress = function (data) {\n\tlet emails = [];\n\tfor (let key in data) {\n\t\tif (data[key]) {\n\t\t\tif (rcmail.crm.app.isJsonString(data[key])) {\n\t\t\t\tlet multiEmail = JSON.parse(data[key]);\n\t\t\t\tfor (let i in multiEmail) {\n\t\t\t\t\temails.push(multiEmail[i].e);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t} else {\n\t\t\t\temails.push(data[key]);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn emails;\n};\nrcube_webmail.prototype.getCrmWindow = function () {\n\tif (opener !== null && opener.parent.CONFIG == 'object') {\n\t\treturn opener.parent;\n\t} else if (typeof parent.CONFIG == 'object') {\n\t\treturn parent;\n\t} else if (typeof parent.parent.CONFIG == 'object') {\n\t\treturn parent.parent;\n\t} else if (typeof opener.crm.CONFIG == 'object') {\n\t\treturn opener.crm;\n\t}\n\treturn false;\n};\n"],"names":["window","rcmail","addEventListener","crm","getCrmWindow","env","compose_commands","push","register_command","addFilesFromCRM","selectTemplate","module","part","selectAdress","rcube_webmail","prototype","app","showRecordsList","src_module","multi_select","additionalInformations","modal","instance","setSelectEvent","responseData","addFilesToMail","ids","Object","keys","data","_id","compose_id","_uploadid","getTime","http_post","set_busy","search_params","yf_crmRecord","yf_crmModule","view","yf_crmView","jQuery","document","find","recordId","chElement","val","ajax","type","url","id","record_id","select_module","dataType","success","html","content","ed","oldSubject","subject","tinyMCE","get","composebody","activeEditor","getContent","tinymce","setContent","oldBody","attachments","e","getEmailAddresses","done","emails","length","$","value","paetElement","charAt","join","change","showNotify","text","vtranslate","animation","Deferred","label","email","target","aDeferred","resolve","getRecordDetails","record","fieldType","i","getFirstEmailAddress","result","promise","key","isJsonString","JSON","parse","multiEmail","parent","CONFIG","opener"],"mappings":"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"}